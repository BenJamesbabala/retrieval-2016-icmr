{
  "name": "Bags of Local Convolutional Features for Scalable Instance Search",
  "tagline": "ACM International Conference on Multimedia Retrieval 2016 (Best poster award)",
  "body": "| ![Logo Icmr][icmrlogo] | Paper accepted at [The Annual ACM International Conference on Multimedia Retrieval (ICMR) ](http://www.icmr2016.com/index.html)   |\r\n|:-:|---|\r\n\r\n[icmrlogo]: https://raw.githubusercontent.com/evamohe/BoW_CNN_InstanceSearch/master/authors/logo_1.jpg?token=AHPpwJEFJz9ZB5Q5RyZ_O6HuU7_S2yp-ks5X1vMgwA%3D%3D\r\n\r\n| ![Eva Mohedano][EvaMohedano-photo] | ![Amaia Salvador][AmaiaSalvador-photo] | ![Kevin McGuinness][KevinMcGuinness-photo] |  ![Xavier Giro-i-Nieto][XavierGiro-photo] | ![Noel O'Connor][NoelOConnor-photo]  | ![Ferran Marques][FerranMarques-photo]|\r\n|:-:|:-:|:-:|:-:|:-:|:-:|\r\n| [Eva Mohedano][EvaMohedano-web]  | [Amaia Salvador][AmaiaSalvador-photo] | [Kevin McGuinness][KevinMcGuinness-web]   | [Xavier Giro-i-Nieto][XavierGiro-web]   | [Noel O'Connor][NoelOConnor-web]   | [ Ferran Marques][FerranMarques-web]  |\r\n\r\n[EvaMohedano-web]: https://www.insight-centre.org/users/eva-mohedano\r\n[AmaiaSalvador-web]: https://imatge.upc.edu/web/people/amaia-salvador\r\n[KevinMcGuinness-web]: https://www.insight-centre.org/users/kevin-mcguinness\r\n[XavierGiro-web]: https://imatge.upc.edu/web/people/xavier-giro\r\n[NoelOConnor-web]: https://www.insight-centre.org/users/noel-oconnor\r\n[FerranMarques-web]: https://imatge.upc.edu/web/people/ferran-marques\r\n\r\n\r\n[EvaMohedano-photo]: https://raw.githubusercontent.com/imatge-upc/retrieval-2016-lostobject/master/authors/Eva.jpg?token=AKsMd4iuttxHH44mYL3mPpJEtSvXVXF8ks5Xe-AWwA%3D%3D \"Eva Mohedano\"\r\n[AmaiaSalvador-photo]: https://raw.githubusercontent.com/evamohe/BoW_CNN_InstanceSearch/master/authors/salvador.jpg?token=AHPpwCjeOzq3duY0lkLTXEe8H7giXJEPks5X1vG2wA%3D%3D \"Amaia Salvador\" \r\n[KevinMcGuinness-photo]: https://raw.githubusercontent.com/imatge-upc/retrieval-2016-lostobject/master/authors/Kevin.jpg?token=AKsMd4VU31T7Bh8CztufWEWNudazbB_Uks5Xe-AxwA%3D%3D \"Kevin McGuinness\"\r\n[XavierGiro-photo]: https://raw.githubusercontent.com/evamohe/BoW_CNN_InstanceSearch/master/authors/giro.jpg?token=AHPpwDdVdPYfMIwMBgHbjK9pPMJva1GOks5X1vHIwA%3D%3D \"Xavier Giro-i-Nieto\"\r\n[NoelOConnor-photo]: https://raw.githubusercontent.com/imatge-upc/retrieval-2016-lostobject/master/authors/Noel.jpg?token=AKsMdyemO5eJke9B9rqdRtA7otJscq1wks5Xe-BEwA%3D%3D \"Noel O'Connor\"\r\n[FerranMarques-photo]: https://raw.githubusercontent.com/evamohe/BoW_CNN_InstanceSearch/master/authors/marques.jpg?token=AHPpwN3NJU0PqS8i-r2Ng7TpRjlQV22vks5X1vHWwA%3D%3D\r\n\r\nA joint collaboration between:\r\n\r\n| ![logo-insight] | ![logo-dcu] | ![logo-upc] | ![logo-etsetb] | ![logo-gpi] | \r\n|:-:|:-:|:-:|:-:|:-:|\r\n| [Insight Centre for Data Analytics][insight-web] | [Dublin City University (DCU)][dcu-web]  |[Universitat Politecnica de Catalunya (UPC)][upc-web]   | [UPC ETSETB TelecomBCN][etsetb-web]  | [UPC Image Processing Group][gpi-web] | \r\n\r\n[insight-web]: https://www.insight-centre.org/ \r\n[dcu-web]: http://www.dcu.ie/\r\n[upc-web]: http://www.upc.edu/?set_language=en \r\n[etsetb-web]: https://www.etsetb.upc.edu/en/ \r\n[gpi-web]: https://imatge.upc.edu/web/ \r\n\r\n\r\n[logo-insight]: https://raw.githubusercontent.com/imatge-upc/saliency-2016-cvpr/master/logos/insight.jpg \"Insight Centre for Data Analytics\"\r\n[logo-dcu]: https://raw.githubusercontent.com/imatge-upc/saliency-2016-cvpr/master/logos/dcu.png \"Dublin City University\"\r\n[logo-upc]: https://raw.githubusercontent.com/imatge-upc/saliency-2016-cvpr/master/logos/upc.jpg \"Universitat Politecnica de Catalunya\"\r\n[logo-etsetb]: https://raw.githubusercontent.com/imatge-upc/saliency-2016-cvpr/master/logos/etsetb.png \"ETSETB TelecomBCN\"\r\n[logo-gpi]: https://raw.githubusercontent.com/imatge-upc/saliency-2016-cvpr/master/logos/gpi.png \"UPC Image Processing Group\"\r\n\r\n## Abstract \r\nThis work proposes a simple instance retrieval pipeline based on encoding the convolutional features of CNN using the bag of words aggregation scheme (BoW). Assigning each local array of activations in a convolutional layer to a visual word produces an assignment map, a compact representation that relates regions of an image with a visual word. We use the assignment map for fast spatial reranking, obtaining object localizations that are used for query expansion. We demonstrate the suitability of the BoW representation based on local CNN features for instance retrieval, achieving competitive performance on the Oxford and Paris buildings benchmarks. We show that our proposed system for CNN feature aggregation with BoW outperforms state-of-the-art techniques using sum pooling at a subset of the challenging TRECVid INS benchmark.\r\n\r\n\r\n## Publication\r\n\r\n[Paper link](http://delivery.acm.org/10.1145/2920000/2912061/p327-mohedano.pdf?ip=136.206.26.116&id=2912061&acc=ACTIVE%20SERVICE&key=846C3111CE4A4710%2E821500BF45340188%2E4D4702B0C3E38B35%2E4D4702B0C3E38B35&CFID=834414703&CFTOKEN=41969317&__acm__=1473100476_3638b03bb0e3539dc3119507f650f0cc)\r\n\r\n![Image of the paper](https://raw.githubusercontent.com/evamohe/BoW_CNN_InstanceSearch/master/docs/image.jpeg?token=AHPpwMnNlL9yWB3Lt7588wSrlzim1tO4ks5X1vazwA%3D%3D)\r\n\r\nPlease cite with the following Bibtex code:\r\n\r\n````\r\n@inproceedings{Mohedano:2016:BLC:2911996.2912061,\r\n author = {Mohedano, Eva and McGuinness, Kevin and O'Connor, Noel E. and Salvador, Amaia and Marques, Ferran and Giro-i-Nieto, Xavier},\r\n title = {Bags of Local Convolutional Features for Scalable Instance Search},\r\n booktitle = {Proceedings of the 2016 ACM on International Conference on Multimedia Retrieval},\r\n series = {ICMR '16},\r\n year = {2016},\r\n isbn = {978-1-4503-4359-6},\r\n location = {New York, New York, USA},\r\n pages = {327--331},\r\n numpages = {5},\r\n url = {http://doi.acm.org/10.1145/2911996.2912061},\r\n doi = {10.1145/2911996.2912061},\r\n acmid = {2912061},\r\n publisher = {ACM},\r\n address = {New York, NY, USA},\r\n keywords = {bag of words, convolutional neural networks, instance retrieval},\r\n} \r\n````\r\n\r\n## Code Instructions\r\n\r\n### Description\r\n\r\nIt contains scripts to build Bag of Visual Words based on local CNN features to perform instance search in three different datasets:\r\n\r\n* [Oxford Buildings](http://www.robots.ox.ac.uk/~vgg/data/oxbuildings/) (and Oxford 105k).\r\n\r\n* [Paris Buildings](http://www.robots.ox.ac.uk/~vgg/data/parisbuildings/) (and Paris 106k).\r\n\r\n* Trecvid_subset: Subset of 23.614 keyframes/~13.000video shots from [TRECVid-INS](http://www-nlpir.nist.gov/projects/tv2015/) dataset. Keyframes extracted uniformly at 1/4fps. Queries and groundtruth correspond to [INS2013](http://www-nlpir.nist.gov/projects/tv2013/tv2013.html).\r\n\r\n\r\n### Prerequisits\r\n\r\nPython packages necessary specified in *requirements.txt* run:\r\n\r\n```\r\n pip install -r requirements.txt\r\n\r\n```\r\n\r\nIt also needs:\r\n\r\n*  **[caffe](http://caffe.berkeleyvision.org/)** with python support\r\n\r\n*  **[vlfeat](https://github.com/dougalsutherland/vlfeat-ctypes)** library\r\n    * Once installed, modify 'kmeans.py' file, located in the vlfeat python package: (i.e /usr/local/lib/python2.7/dist-packages/vlfeat_ctypes-0.1.4-py2.7.egg/vlfeat/kmeans.py)\r\n      for lib/kmeans.py of this repo.\r\n\r\n*  **invidx** module. Follow instructions in 'lib/py=inverted-index'/\r\n\r\n**NOTE**\r\nYou can create a virtual enviroment to set the specific dependences of this project in an independent enviroment, without modifying your original python enviroment. Check [how to create a virtual enviroment](http://docs.python-guide.org/en/latest/dev/virtualenvs/). Using *--system-site-packages* flag when creating the venv will copy all the packages from your python installation. This will prevent you of re-installing packages in the new virtual enviroment that you have already installed. This will allow you to install only the new packages.\r\n\r\n\r\n### How to run it?\r\n\r\n*bow_pipeline* folder contain the main scripts. Parameters must be specified in the *settings.json* file located in the folder named as the dataset.\r\n\r\n\r\n#### Step 1: FEATURE EXTRACTION (bow_pipeline/A_feature_extraction.py)\r\n\r\nThis script extracts features from a pre-trained CNN (by default the fully convolutional [VGG-16 network](https://gist.github.com/ksimonyan/211839e770f7b538e2d8#file-readme-md). It computers descriptors from the specified layer/s *Layer_output* parameter in a levelDB dataset in *featuresDB* paramenter in the *settings.json*, with the format [*featuresDB*]/[*layer*]_db.\r\n\r\n**NOTE**\r\nFeatures are stored as the original dictionary created by the *Net* class from [caffe](http://caffe.berkeleyvision.org/). For reading, you should use the class *Local_Feature_ReaderDB* located in *bow_pipeline/reader.py*. This class contains methods to extract local features in the format (*n_samples*, *n_dimensions*)/image for BoW encoding. It also performs SumPooling, generating (*1*, *n_dimensions*)/image. It also contains methods to interpolate feature maps when reading. For more info in, check *bow_pipeline/reader.py* script.\r\n\r\n\r\n#### Step 2: BUILDING VISUAL VOCABULARY (bow_pipeline/B_processing_clustering.py)\r\n\r\nIt performs the clustering of the local features. It is necessary to set the\r\nfollowing parameters:\r\n\r\n```\r\nTRAIN_PCA=True -- If we want PCA/whitenning (default true)\r\nTRAIN_CENTROIDS=True -- if we want to train centroids (default true)\r\nl2norm=True -- if we want to perform l2-norm on the features (default true)\r\nn_centers=25000 -- # of clusters\r\npca_dim=512 -- dimensions when doing PCA\r\n```\r\n\r\nIt is necessary to specify the settings.json (different for each dataset, which contains paths for reading features/store models.\r\n\r\n\r\n#### Step 3: ASSIGNMENTS AND INVERTED FILE GENERATION (bow_pipeline/C_bow_representation.py)\r\n\r\nOnce the visual vocabulary is build, we can compute the assignments based on the local features/image and we can index the dataset of images. It is necessary to set the following parameters (check the script):\r\n\r\n```\r\nsettings file for the dataset\r\ndim_input -- network input dimensions in string format\r\nnetwork=\"vgg16\" -- string with network name to use\r\nlist_layers -- list with layer/s to use\r\nnew_dim -- tuple with the feature map dimension\r\n```\r\n\r\n\r\n#### Step 4: RANKINGS GENERATION (bow_pipeline/D_rankings_BoW.py)\r\n\r\nIt uses the inverted file generated and generates the rankigns for the queries. It computes the assignments for the query on-the-fly. It is necessary to set parameters as in Step 3, with the additional:\r\n\r\n```\r\n  \t- masking = 3 (Kind of masking applied on query):\r\n        0== No maks;\r\n        1 == Only consider words from foreground;\r\n        2 == Only consider words from background [CHANGED];\r\n        3 == Apply inverse weight to the foreground object\r\n  \t- augmentation = [0] [TO REVIEW]\r\n        0 == No augmentation;\r\n        1 == 0+Flipped image;\r\n        2 == 0+Zoomed image (same size as input net, but just capturing center crop\r\n             of the image when it has been zoomed to the double size).\r\n        3 == 0+Flipped zoomed crop\r\n    - QUERY_EXPANSION [TO_ADD]\r\n```\r\n\r\n**NOTE**\r\nIf using bow_pipeline/D_rankings_Pooling.py; Skip steps 2 and 3. The whole pipeline is based in sumpooled features (without inverted index and codebook generation).\r\n\r\n*.txt* files are generated per query under *datasetFolder/lists_[bow/pooling]*.\r\n\r\n\r\n#### Step 5: EVALUATION (bow_pipeline/evaluate_[Oxf_Par/trecvid].py)\r\n\r\nIt computes mean average precission for rankings generated in Step 4.\r\n\r\n* *evaluate_Oxf_Par* for Paris and Oxford datasets\r\n\r\n* evaluate_trecvid for TRECVid subset.\r\n\r\n\r\n**NOTE** It generate *map.txt* in bow_pipeline folder with results.\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}